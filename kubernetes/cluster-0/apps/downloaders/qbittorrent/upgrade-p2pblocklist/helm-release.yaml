---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: &app qbittorrent-upgrade-p2pblocklist
  namespace: &namespace default
spec:
  interval: 15m
  chart:
    spec:
      chart: raw
      version: v0.3.1
      sourceRef:
        kind: HelmRepository
        name: dysnix
        namespace: flux-system
  install:
    createNamespace: true
    remediation:
      retries: 5
  upgrade:
    remediation:
      retries: 5
  dependsOn:
    - name: qbittorrent
      namespace: default
  values:
    resources:
      - apiVersion: batch/v1
        kind: CronJob
        metadata:
          name: *app
          namespace: *namespace
        spec:
          schedule: "@daily"
          jobTemplate:
            spec:
              template:
                metadata:
                  name: *app
                spec:
                  serviceAccountName: jobs
                  containers:
                    - name: *app
                      image: ghcr.io/auricom/kubectl:1.25.4@sha256:677c96eb9a7296b5a318d726c565d45ac470d0d7591b28c7df5cfbc355a40358
                      imagePullPolicy: IfNotPresent
                      command:
                        - "/bin/bash"
                        - "-c"
                        - |
                          #!/bin/bash

                          set -o errexit
                          set -o nounset

                          curl --location https://github.com/DavidMoore/ipfilter/releases/download/lists/ipfilter.dat.gz --output /tmp/ipfilter.dat.gz
                          gunzip /tmp/ipfilter.dat.gz
                          result=$(kubectl get pod --selector app.kubernetes.io/name=qbittorrent --output custom-columns=:metadata.name --namespace default)
                          QBITTORRENT_POD=$(echo $result | awk '{ print $NF }')
                          echo $QBITTORRENT_POD | grep qbittorrent
                          if [[ $(echo $QBITTORRENT_POD | grep qbittorrent) ]]; then
                            kubectl cp /tmp/ipfilter.dat default/$QBITTORRENT_POD:/config/ipfilter.dat
                            kubectl rollout restart deployment qbittorrent --namespace default && curl -m 10 --retry 5 http://healthchecks.default.svc.cluster.local.:/ping/${SECRET_HEALTHCHECKS_PING_KEY}/k3s-qbittorrent-p2pblocklist
                          else
                            echo "qbittorrent deployment not found"
                            exit 1
                          fi
                  restartPolicy: Never
