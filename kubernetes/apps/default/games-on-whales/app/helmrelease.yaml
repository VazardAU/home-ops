---
# yaml-language-server: $schema=https://kubernetes-schemas.devbu.io/helmrelease_v2beta1.json
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: &app games-on-whales
  namespace: default
spec:
  interval: 15m
  chart:
    spec:
      chart: games-on-whales
      version: 2.0.0
      interval: 15m
      sourceRef:
        kind: HelmRepository
        name: angelnu
        namespace: flux-system
  maxHistory: 3
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    env:
      TIME_ZONE: ${TIMEZONE}
    envFrom:
      - secretRef:
          name: *app
    nodeSelector:
      feature.node.kubernetes.io/custom-nvidia-gpu: "true"
    service:
      main:
        type: LoadBalancer
        loadBalancerIP: "${CLUSTER_LB_GOW}"
        externalTrafficPolicy: Local
        annotations:
          metallb.universe.tf/allow-shared-ip: games-on-whales
      udp:
        type: LoadBalancer
        loadBalancerIP: "${CLUSTER_LB_GOW}"
        externalTrafficPolicy: Local
        annotations:
          metallb.universe.tf/allow-shared-ip: games-on-whales
    ingress:
      main:
        enabled: true
        ingressClassName: "nginx"
        annotations:
          external-dns.home.arpa/enabled: "true"
          hajimari.io/icon: mdi:controller
          ingress.kubernetes.io/whitelist-source-range: "192.168.0.0/16"
        hosts:
          - host: &host "lobby.${SECRET_CLUSTER_DOMAIN}"
            paths:
              - path: /
                pathType: Prefix
        tls:
          - hosts:
              - *host
    podSecurityContext:
      runAsUser: 568
      runAsGroup: 568
      fsGroup: 568
      fsGroupChangePolicy: "OnRootMismatch"
    persistence:
      home:
        enabled: true
        existingClaim: gow-config
      software:
        enabled: true
        type: custom
        volumeSpec:
          nfs:
            server: ${LOCAL_LAN_TRUENAS}
            path: /mnt/data/media-data/software
      nvidia-drv:
        enabled: true
        type: hostPath
        hostPathType: File
        readOnly: true
        mountPath: /nvidia/xorg/nvidia_drv.so
        hostPath: /usr/lib/x86_64-linux-gnu/nvidia/xorg/nvidia_drv.so
      libglxserver-nvidia:
        enabled: true
        type: hostPath
        hostPathType: File
        readOnly: true
        mountPath: /nvidia/xorg/libglxserver_nvidia.so
        hostPath: /usr/lib/x86_64-linux-gnu/nvidia/xorg/libglxserver_nvidia.so
    podAnnotations:
      secret.reloader.stakater.com/reload: *app
    sunshine:
      image:
        repository: ghcr.io/angelnu/sunshine
        tag: sha-f5e468f
        pullPolicy: Always
      user: admin
      password: "$(SUNSHINE_PASSWORD)"
    xorg:
      image:
        repository: ghcr.io/games-on-whales/xorg
        tag: 1.0.0
        pullPolicy: IfNotPresent
      refreshrate: 60
      resolution: 1920x1080
      volumeMounts:
        - name: nvidia-drv
          mountPath: /nvidia/xorg/nvidia_drv.so
          readOnly: true
        - name: libglxserver-nvidia
          mountPath: /nvidia/xorg/libglxserver_nvidia.so
          readOnly: true
    pulseaudio:
      image:
        repository: ghcr.io/games-on-whales/pulseaudio
        tag: 1.0.0
        pullPolicy: IfNotPresent
    retroarch:
      enabled: false
      image:
        repository: ghcr.io/angelnu/retroarch
        tag: sha-fc9d5ae
        pullPolicy: IfNotPresent
      logLevel: info
      volumeMounts:
        - name: software
          mountPath: /home/retro/software
          #readOnly: true
    steam:
      enabled: true
      image:
        repository: ghcr.io/angelnu/steam
        tag: sha-c387cd3
        pullPolicy: IfNotPresent
      protonLog: 1
    firefox:
      enabled: false
      image:
        repository: andrewmackrodt/firefox-x11
        tag: 1.0.0
        pullPolicy: IfNotPresent
      volumeMounts: []
    mkhomeretrodirs:
      image:
        repository: busybox
        tag: 1.36.1
        pullPolicy: IfNotPresent
