---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: resilio-sync
  namespace: data
  labels:
    app.kubernetes.io/instance: resilio-sync
    app.kubernetes.io/name: resilio-sync
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/instance: resilio-sync
      app.kubernetes.io/name: resilio-sync
  updateStrategy:
    type: RollingUpdate
  serviceName: resilio-sync
  strategy:
  template:
    metadata:
      labels:
        app.kubernetes.io/instance: resilio-sync
        app.kubernetes.io/name: resilio-sync
    spec:
      containers:
        - image: ghcr.io/linuxserver/resilio-sync:version-2.7.3.1381-1
          name: resilio-sync-claude
          env:
            - name: TZ
              value: "${TIMEZONE}"
            - name: PUID
              value: "1026"
            - name: PGID
              value: "1000"
          ports:
            - containerPort: 8888
              name: http-claude
            - containerPort: 55555
              name: com-claude
          volumeMounts:
            - name: config
              mountPath: /config
              subPath: claude
            - name: sync-conf-claude
              mountPath: /config/sync.conf
              subPath: sync.conf
            - name: home-claude
              mountPath: /sync/home/claude
            - name: photo
              mountPath: /sync/photo
            - name: backups
              mountPath: /sync/backup
            - name: music-transcoded
              mountPath: /sync/music_transcoded
            - name: video
              mountPath: /sync/video
              subPath: video
            - name: shared-documents
              mountPath: /sync/shared-documents
        - image: ghcr.io/linuxserver/resilio-sync:version-2.7.3.1381-1
          name: resilio-sync-helene
          env:
            - name: TZ
              value: "${TIMEZONE}"
            - name: PUID
              value: "1027"
            - name: PGID
              value: "1000"
          ports:
            - containerPort: 8889
              name: http-helene
            - containerPort: 55556
              name: com-helene
          volumeMounts:
            - name: config
              mountPath: /config
              subPath: helene
            - name: sync-conf-helene
              mountPath: /config/sync.conf
              subPath: sync.conf
            - name: home-helene
              mountPath: /sync/home
            - name: backups
              mountPath: /sync/backup
      volumes:
        - name: config
          persistentVolumeClaim:
            claimName: resilio-sync-config
        - name: sync-conf-claude
          configMap:
            name: resilio-sync-claude-conf
        - name: sync-conf-helene
          configMap:
            name: resilio-sync-helene-conf
        - name: home-claude
          nfs:
            server: "${LOCAL_LAN_TRUENAS}"
            path: /mnt/storage/home/claude
        - name: home-helene
          nfs:
            server: "${LOCAL_LAN_TRUENAS}"
            path: /mnt/storage/home/helene
        - name: backups
          nfs:
            server: "${LOCAL_LAN_TRUENAS}"
            path: /mnt/storage/backups
        - name: photo
          nfs:
            server: "${LOCAL_LAN_TRUENAS}"
            path: /mnt/storage/photo
        - name: music-transcoded
          nfs:
            server: "${LOCAL_LAN_OPENMEDIAVAULT}"
            path: /export/music_transcoded
        - name: video
          nfs:
            server: "${LOCAL_LAN_TRUENAS}"
            path: /mnt/storage/video
        - name: shared-documents
          nfs:
            server: "${LOCAL_LAN_TRUENAS}"
            path: /mnt/storage/shared-documents
      dnsConfig:
        options:
          - name: ndots
            value: "1"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: resilio-sync-claude-conf
  namespace: data
data:
  sync.conf: |
    {
        "listening_port" : 55555,
        "storage_path" : "/config",
        "vendor" : "docker",
        "display_new_version": false,

        "directory_root_policy" : "belowroot",
        "directory_root" : "/sync/",
        "webui" :
        {
      "listen" : "0.0.0.0:8888",
      "allow_empty_password" : false,
            "dir_whitelist" : [ "/sync", "/sync/folders", "/sync/mounted_folders" ]
        }
    }
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: resilio-sync-helene-conf
  namespace: data
data:
  sync.conf: |
    {
        "listening_port" : 55556,
        "storage_path" : "/config",
        "vendor" : "docker",
        "display_new_version": false,

        "directory_root_policy" : "belowroot",
        "directory_root" : "/sync/",
        "webui" :
        {
      "listen" : "0.0.0.0:8889",
      "allow_empty_password" : false,
            "dir_whitelist" : [ "/sync", "/sync/folders", "/sync/mounted_folders" ]
        }
    }
---
apiVersion: v1
kind: Service
metadata:
  annotations:
    prometheus.io/probe: "true"
    prometheus.io/protocol: tcp
  labels:
    app.kubernetes.io/instance: resilio-sync
    app.kubernetes.io/name: resilio-sync
  name: resilio-sync
  namespace: data
spec:
  ports:
    - name: http-claude
      port: 8888
      protocol: TCP
      targetPort: 8888
    - name: http-helene
      port: 8889
      protocol: TCP
      targetPort: 8889
    - name: com-claude
      port: 55555
      protocol: TCP
      targetPort: 55555
    - name: com-helene
      port: 55556
      protocol: TCP
      targetPort: 55556
  selector:
    app.kubernetes.io/instance: resilio-sync
    app.kubernetes.io/name: resilio-sync
  type: LoadBalancer
  externalIPs:
    - ${CLUSTER_LB_RESILIOSYNC}
  externalTrafficPolicy: Local
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  # annotations:
  # traefik.ingress.kubernetes.io/router.entrypoints: "websecure"
  labels:
    app.kubernetes.io/instance: resilio-sync
    app.kubernetes.io/name: resilio-sync
  name: resilio-sync
  namespace: data
spec:
  ingressClassName: "nginx"
  tls:
    - hosts:
        - "resilio-sync-claude.${SECRET_CLUSTER_DOMAIN}"
        - "resilio-sync-helene.${SECRET_CLUSTER_DOMAIN}"
      secretName: "${SECRET_CLUSTER_CERTIFICATE_DEFAULT}"
  rules:
    - host: "resilio-sync-claude.${SECRET_CLUSTER_DOMAIN}"
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: resilio-sync
                port:
                  number: 8888
    - host: "resilio-sync-helene.${SECRET_CLUSTER_DOMAIN}"
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: resilio-sync
                port:
                  number: 8889
