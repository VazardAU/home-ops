---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: benji
  namespace: rook-ceph
spec:
  releaseName: benji
  interval: 5m
  chart:
    spec:
      chart: ./charts/benji-k8s
      version: 0.2.0
      sourceRef:
        kind: GitRepository
        name: benji-charts
        namespace: flux-system
      interval: 5m
  values:
    timeZone: Europe/Paris
    benji:
      configuration:
        configurationVersion: "1"
        databaseEngine: postgresql://benji:secret@benji-postgresql-headless:5432/benji
        defaultStorage: storage-1
        storages:
          - name: storage-1
            storageId: 1
            module: file
            configuration:
              path: /mnt/storage/backups/benji
        ios:
          - module: rbdaio
            name: replicapool
            configuration:
              simultaneousReads: 3
              simultaneousWrites: 3
              cephConfigFile: /etc/ceph/ceph.conf
              clientIdentifier: admin
              newImageFeatures:
                - RBD_FEATURE_LAYERING
                - RBD_FEATURE_EXCLUSIVE_LOCK
                - RBD_FEATURE_STRIPINGV2
                - RBD_FEATURE_OBJECT_MAP
                - RBD_FEATURE_FAST_DIFF
                - RBD_FEATURE_DEEP_FLATTEN
      cronJob:
        activeDeadlineSeconds: null
        startingDeadlineSeconds: null
      crontab:
        - name: backup-pvc
          schedule: "00 22 * * *"
          command:
            - benji-backup-pvc
            - --selector
            - "benji-backup.me/instance=benji-k8s"
        - name: benji-enforce
          schedule: "30 22 * * *"
          command:
            - benji-command
            - enforce
            - days14
            - 'labels["benji-backup.me/instance"] == "benji-k8s"'
        - name: cleanup
          schedule: "00 23 * * *"
          command:
            - benji-command
            - cleanup
      volumes:
        - name: ceph-etc
          configMap:
            name: benji-ceph-etc
            defaultMode: 0444
        - name: ceph-keyring
          secret:
            secretName: rook-ceph-admin-keyring
            defaultMode: 0444
        - name: nfs-backups-benji
          persistentVolumeClaim:
            claimName: nfs-backups-benji
      volumeMounts:
        - name: ceph-etc
          mountPath: /etc/ceph/ceph.conf
          subPath: ceph.conf
          readOnly: true
        - name: ceph-keyring
          mountPath: /etc/ceph/keyring
          subPath: keyring
          readOnly: true
        - name: nfs-backups-benji
          mountPath: /mnt/storage/backups/benji
    fsfreeze:
      enabled: true
    postgresql:
      enabled: true
      postgresqlUsername: benji
      postgresqlDatabase: benji
      postgresqlPassword: secret
    pushgateway:
      image:
        registry: docker.io
        repository: prom/pushgateway
        tag: v1.4.2
        pullPolicy: IfNotPresent
      nameOverride: pushgateway
