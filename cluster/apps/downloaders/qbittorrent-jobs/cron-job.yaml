---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: qbittorrent-upgrade-p2pblocklist
  namespace: default
spec:
  schedule: "@daily"
  jobTemplate:
    spec:
      template:
        metadata:
          name: qbittorrent-upgrade-p2pblocklist
        spec:
          serviceAccountName: jobs
          containers:
            - name: qbittorrent-upgrade-p2pblocklist
              image: ghcr.io/auricom/kubectl:v1.25.0@sha256:0862a94ca7d546521aa6c2f917fab5afdcc6caa54a48e0581b29a37c1b11f37d
              imagePullPolicy: IfNotPresent
              command:
                - "/bin/bash"
                - "-c"
                - |
                  #!/bin/bash

                  set -o errexit
                  set -o nounset

                  curl --location https://github.com/DavidMoore/ipfilter/releases/download/lists/ipfilter.dat.gz --output /tmp/ipfilter.dat.gz
                  gunzip /tmp/ipfilter.dat.gz
                  result=$(kubectl get pod --selector app.kubernetes.io/name=qbittorrent --output custom-columns=:metadata.name --namespace default)
                  QBITTORRENT_POD=$(echo $result | awk '{ print $NF }')
                  echo $QBITTORRENT_POD | grep qbittorrent
                  if [[ $(echo $QBITTORRENT_POD | grep qbittorrent) ]]; then
                    kubectl cp /tmp/ipfilter.dat default/$QBITTORRENT_POD:/config/ipfilter.dat
                    kubectl rollout restart deployment qbittorrent --namespace default && curl -m 10 --retry 5 http://healthchecks.default.svc.cluster.local.:/ping/${SECRET_HEALTHCHECKS_PING_KEY}/k3s-qbittorrent-p2pblocklist
                  else
                    echo "qbittorrent deployment not found"
                    exit 1
                  fi
          restartPolicy: Never
