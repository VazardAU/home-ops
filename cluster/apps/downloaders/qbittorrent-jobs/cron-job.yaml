---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: qbittorrent-upgrade-p2pblocklist
  namespace: default
spec:
  schedule: "@daily"
  jobTemplate:
    spec:
      template:
        metadata:
          name: qbittorrent-upgrade-p2pblocklist
        spec:
          serviceAccountName: jobs
          containers:
            - name: qbittorrent-upgrade-p2pblocklist
              image: ghcr.io/auricom/kubectl:v1.25.0@sha256:0862a94ca7d546521aa6c2f917fab5afdcc6caa54a48e0581b29a37c1b11f37d
              imagePullPolicy: IfNotPresent
              command:
                - "/bin/bash"
                - "-c"
                - |
                  #!/bin/bash

                  set -o nounset
                  set -o errexit

                  curl --location https://github.com/DavidMoore/ipfilter/releases/download/lists/ipfilter.dat.gz --output /tmp/ipfilter.dat.gz
                  gunzip /tmp/ipfilter.dat.gz
                  result=$(kubectl get pod --selector app.kubernetes.io/name=qbittorrent --output custom-columns=:metadata.name --namespace default)
                  QBITTORRENT_POD=$(echo $result | awk '{ print $NF }')
                  echo $QBITTORRENT_POD | grep qbittorrent
                  test $? -eq 0 && kubectl cp /tmp/ipfilter.dat default/$QBITTORRENT_POD:/config/ipfilter.dat
                  curl -m 10 --retry 5 http://healthchecks.default.svc.cluster.local.:/ping/{ping_key}/k3s-qbittorrent-p2pblocklist
                  kubectl rollout restart deployment qbittorrent --namespace default
          restartPolicy: Never
