---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: gitea-repositories-backup
  namespace: development
spec:
  schedule: "@weekly"
  jobTemplate:
    spec:
      template:
        metadata:
          name: gitea-repositories-backup
        spec:
          imagePullSecrets:
            - name: regcred
          containers:
            - name: trash-updater
              image: bitnami/kubectl:1.21.3
              imagePullPolicy: IfNotPresent
              command:
                - "bin/sh"
                - "-ec"
                - |
                  #!/bin/sh

                  set -o nounset
                  set -o errexit

                  DATE=`date +%Y%m%d`
                  ARCHIVE_NAME=gitea-repositories-${DATE}.tar

                  kubectl exec gitea-0 --namespace development -- bash -c "\
                    cd /data/git/gitea-repositories && \
                    tar cvf /tmp/${ARCHIVE_NAME} ./ && \
                    zstd /tmp/${ARCHIVE_NAME} && \
                    scp -i /opt/id_rsa /tmp/${ARCHIVE_NAME}.zst homelab@truenas:/mnt/storage/backups/gitea/ && \
                    rm /tmp/${ARCHIVE_NAME}.zst"
              volumeMounts:
                - name: secret
                  mountPath: /opt/id_rsa
                  subPath: deployment-rsa-priv-key
          volumes:
            - name: secret
              secret:
                secretName: drone-pipelines
          restartPolicy: Never
