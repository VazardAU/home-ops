---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: &app recyclarr
  namespace: &namespace default
spec:
  interval: 15m
  chart:
    spec:
      chart: raw
      version: v0.3.1
      sourceRef:
        kind: HelmRepository
        name: dysnix-charts
        namespace: flux-system
  install:
    createNamespace: true
    remediation:
      retries: 5
  upgrade:
    remediation:
      retries: 5
  dependsOn:
    - name: sonarr
      namespace: default
    - name: radarr
      namespace: default
  values:
    resources:
      - apiVersion: batch/v1
        kind: CronJob
        metadata:
          name: *app
          namespace: *namespace
        spec:
          schedule: "@daily"
          jobTemplate:
            spec:
              ttlSecondsAfterFinished: 86400
              template:
                spec:
                  automountServiceAccountToken: false
                  restartPolicy: OnFailure
                  initContainers:
                    - name: render-configs
                      image: ghcr.io/onedr0p/recyclarr:2.6.1@sha256:c7a3823a4a6a92b2effcd5d341ff1fb13ee6feae09867d11c345caf862b96caf
                      envFrom:
                        - secretRef:
                            name: *app
                      command:
                        - "/bin/bash"
                        - -c
                      args:
                        - "envsubst < /config/recyclarr.yaml > /shared/recyclarr.yaml"
                      volumeMounts:
                        - name: config
                          mountPath: /config
                        - name: shared
                          mountPath: /shared
                  containers:
                    - name: sonarr
                      image: ghcr.io/onedr0p/recyclarr:2.6.1@sha256:c7a3823a4a6a92b2effcd5d341ff1fb13ee6feae09867d11c345caf862b96caf
                      env:
                        - name: TZ
                          value: "${TIMEZONE}"
                      command:
                        - "/bin/bash"
                        - "-c"
                        - |
                          #!/bin/bash

                          /app/recyclarr sonarr --config /config/recyclarr.yaml && curl -fsS -m 10 --retry 5 -o /dev/null http://healthchecks.default.svc.cluster.local./ping/${SECRET_HEALTHCHECKS_PING_KEY}/k3s-recyclarr-sonarr
                      volumeMounts:
                        - name: shared
                          mountPath: /config/recyclarr.yaml
                          subPath: recyclarr.yaml
                          readOnly: true
                    - name: radarrs
                      image: ghcr.io/onedr0p/recyclarr:2.6.1@sha256:c7a3823a4a6a92b2effcd5d341ff1fb13ee6feae09867d11c345caf862b96caf
                      env:
                        - name: TZ
                          value: "${TIMEZONE}"
                      command:
                        - "/bin/bash"
                        - "-c"
                        - |
                          #!/bin/bash

                          /app/recyclarr radarr --config /config/recyclarr.yaml && curl -fsS -m 10 --retry 5 -o /dev/null http://healthchecks.default.svc.cluster.local./ping/${SECRET_HEALTHCHECKS_PING_KEY}/k3s-recyclarr-radarr
                      volumeMounts:
                        - name: shared
                          mountPath: /config/recyclarr.yaml
                          subPath: recyclarr.yaml
                          readOnly: true
                  volumes:
                    - name: config
                      configMap:
                        name: *app
                    - name: shared
                      emptyDir: {}
